syntax = "proto3";

import "google/protobuf/empty.proto";
import "google/api/annotations.proto";

option go_package = "github.com/duc-cnzj/mars/pkg/mars";

message Config {
  // config_file 指定项目下的默认配置文件, 也可以是别的项目的文件，格式为 "pid|branch|filename"
  string config_file = 1;
  // config_file_values 全局配置文件，如果没有 ConfigFile 则使用这个
  string config_file_values = 2;
  string config_field = 3;
  bool is_simple_env = 4;
  // config_file_type 配置文件类型，php/env/yaml...
  string config_file_type = 5;
  // local_chart_path helm charts 目录, charts 文件在项目中存放的目录(必填), 也可以是别的项目的文件，格式为 "pid|branch|path"
  string local_chart_path = 6;
  // branches 启用的分支
  repeated string branches = 7;
  // values_yaml 和 values.yaml 一样
  string values_yaml = 8;
}

message MarsShowRequest {
  int64 project_id = 1;
  string branch = 2;
}

message MarsShowResponse {
  string branch = 1;
  Config config = 2;
}

message GlobalConfigRequest {
  int64 project_id = 1;
}

message GlobalConfigResponse {
  bool enabled = 1;
  Config config = 2;
}

message MarsUpdateRequest {
  int64 project_id = 1;
  Config config = 2;
}

message MarsUpdateResponse {
  Config config = 1;
}

message ToggleEnabledRequest {
  int64 project_id = 1;
  bool enabled = 2;
}

message DefaultChartValuesRequest {
  int64 project_id = 1;
  string branch = 2;
}

message DefaultChartValues {
  string value = 1;
}

service Mars {
  rpc Show(MarsShowRequest) returns (MarsShowResponse) {
    option (google.api.http) = {
      get: "/api/gitlab/projects/{project_id}/mars_config"
    };
  }

  rpc GlobalConfig(GlobalConfigRequest) returns (GlobalConfigResponse) {
    option (google.api.http) = {
      get: "/api/gitlab/projects/{project_id}/global_config"
    };
  }

  rpc ToggleEnabled(ToggleEnabledRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/api/gitlab/projects/{project_id}/toggle_enabled",
      body: "*"
    };
  }

  rpc Update(MarsUpdateRequest) returns (MarsUpdateResponse) {
    option (google.api.http) = {
      put: "/api/gitlab/projects/{project_id}/mars_config",
      body: "*"
    };
  }

  rpc GetDefaultChartValues(DefaultChartValuesRequest) returns (DefaultChartValues) {
    option (google.api.http) = {
      get: "/api/gitlab/projects/{project_id}/default_values",
    };
  }
}