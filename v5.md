# Mars 5.x

## feature

- [x] gorm 改成 ent
- [x] ioc
- [x] 项目不是强绑定 gitlab project
- [x] otel 升级
- [x] error 响应处理，不要返回 500
- [x] 不再支持 `.mars.yaml`
- [x] 废弃 .mars.yaml 的用法
- [ ] swagger -> http sdk
- [ ] 发布 all-in-one.yaml
- [ ] helm charts: k8s gateway api
- [ ] 代码兼容 k8s gateway api
- ~~[ ] .mars.yaml 要和项目导出格式一样~~
- ~~[ ] .mars.yaml 优先级高于全局~~

```text
.
├── api // grpc proto
├── cmd // 入口
├── config_example.yaml // 配置示例
├── doc // api 文档
├── examples // 示例
├── frontend // 前端代码
├── internal // 后端业务代码
├── plugins // 插件
├── third_party // 第三方代码 proto, swagger 等
```

```text
internal
├── annotation // mars 支持的注解
│   ├── annotations.go
├── application
│   ├── app.go
│   ├── bootstrappers // 启动器
│   │   ├── apigateway_bootstrapper.go
│   │   ├── cron_bootstrapper.go
│   │   ├── db_bootstrapper.go
│   │   ├── event_bootstrapper.go
│   │   ├── grpc_bootstrapper.go
│   │   ├── k8s_bootstrapper.go
│   │   ├── metrics_bootstrapper.go
│   │   ├── plugin_bootstrapper.go
│   │   ├── pprof_bootstrapper.go
│   │   ├── s3_bootstrapper.go
│   │   ├── sso_bootstrapper.go
│   │   └── tracing_bootstrapper.go
│   ├── mock_types.go
│   ├── plugins.go
│   ├── types.go
│   └── wire.go
├── auth // 认证
│   ├── auth.go
│   ├── interceptor.go
│   └── wire.go
├── cache // 缓存
│   ├── cache.go
│   ├── cacheadapter.go
│   ├── db_cache.go
│   ├── key.go
│   ├── metrics_wrapper.go
│   ├── mock_cache.go
│   ├── nocache.go
│   └── wire.go
├── config // 配置
│   └── config.go
├── cron // 定时任务
│   ├── command.go
│   ├── cron.go
│   ├── mock_cron.go
│   ├── robfig_cron_v3.go
│   └── wire.go
├── data // 数据层
│   ├── data.go
│   ├── db.go
│   ├── mock_data.go
│   └── wire.go
├── ent
│   ├── accesstoken
├── event // 事件
│   ├── event.go
│   ├── ...
│   └── wire.go
├── filters // ent 过滤器
│   ├── filters.go
├── locker // 分布式锁
│   ├── database_lock.go
│   ├── locker.go
│   ├── memory_lock.go
│   ├── mock_locker.go
│   └── wire.go
├── metrics // metrics
│   ├── metrics.go
│   └── wire.go
├── mlog // 日志
│   ├── logurs.go
│   ├── mlog.go
│   ├── mock_logger.go
│   ├── zap.go
├── repo // repo 层, 与数据库交互, 注册事件和定时任务, 只有这层可以操作数据库
│   ├── accesstoken.go
│   ├── auth.go
│   ├── changelog.go
│   ├── cron.go
│   ├── entpoint.go
│   ├── errorhandler.go
│   ├── event.go
│   ├── file.go
│   ├── git.go
│   ├── helm.go
│   ├── k8s.go
│   ├── mock_repo.go
│   ├── namesapce.go
│   ├── picture.go
│   ├── project.go
│   ├── repo.go
│   └── wire.go
├── server // 服务 http/grpc/ws/metrics/pprof
│   ├── grpc.go
│   ├── http.go
│   ├── metrics.go
│   ├── middlewares
│   │   ├── cors.go
│   │   ├── http_cache.go
│   │   ├── logger.go
│   │   ├── metrics.go
│   │   ├── recovery.go
│   │   ├── route_logger.go
│   │   └── validator.go
│   └── pprof.go
├── services // grpc 服务, 与 repo 层交互, 不可以直接操作数据库
│   ├── access_token.go
│   ├── auth.go
│   ├── changelog.go
│   ├── cluster.go
│   ├── container.go
│   ├── endpoint.go
│   ├── event.go
│   ├── file.go
│   ├── git.go
│   ├── metrics.go
│   ├── mock_svc.go
│   ├── namespace.go
│   ├── picture.go
│   ├── project.go
│   ├── repo.go
│   ├── version.go
│   ├── wire.go
├── socket // ws 通信
│   ├── conn.go
│   ├── controller.go
│   ├── loader.go
│   ├── messager.go
│   ├── mock_socket.go
│   ├── release_installer.go
│   ├── runner.go
│   ├── safewritechan.go
│   ├── task_manager.go
│   ├── terminal.go
│   └── wire.go
├── transformer // repo -> proto 转换器
│   ├── accesstoken.go
│   ├── changelog.go
│   ├── cluster.go
│   ├── event.go
│   ├── file.go
│   ├── namespace.go
│   ├── project.go
│   ├── repo.go
├── uploader // 上传文件
│   ├── disk.go
│   ├── mock_uploader.go
│   ├── s3.go
│   ├── uploader.go
│   └── wire.go
└── util // 通用工具
    ├── closeable
    │   ├── closeable.go
    ├── counter
    │   ├── counter.go
    ├── date
    │   ├── date.go
    ├── hash
    │   ├── sha256.go
    ├── k8s
    │   ├── k8s.go
    ├── mars
    │   ├── mars.go
    ├── pagination
    │   ├── pagination.go
    ├── pipeline
    │   ├── pipeline.go
    ├── proxy
    │   ├── proxy.go
    ├── rand
    │   ├── rand.go
    ├── serialize
    │   ├── serialize.go
    ├── timer
    │   ├── timer.go
    ├── xsort
    │   ├── priority.go
    └── yaml
        ├── yaml.go
```
